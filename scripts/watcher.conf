# Go Watcher - Watch a directory and upload to S3
#
# Required-Start:    $local_fs $remote_fs $network $syslog
# Required-Stop:     $local_fs $remote_fs $network $syslog

description "GoWatcher - Watch a directory and upload to S3"

start on runlevel [2345]
stop on runlevel [!2345]

# Give up if restart occurs 10 times in 600 seconds (10 minutes)
respawn limit 10 600

# Setuid only came in much later (upstart 1.4), and this archaic system
# doesn't understand the setuid setup, grrr
#
#setuid _laura

chdir /opt/laura
env HOME="/opt/laura"
export HOME

script

# Set up locations for log files
touch /var/log/watcher.log
chown _laura /var/log/watcher.log

if [ ! -d /var/log/watcher ]; then
	mkdir -p /var/log/watcher
fi

chown -R _laura /var/log/watcher

if [ -x /opt/laura/watcher/setup_environment.sh ]; then
    /opt/laura/watcher/setup_environment.sh
fi

if [ -x /opt/laura/watcher/config.sh ]; then
    . /opt/laura/watcher/config.sh
fi

# Newer versions of upstart (1.4+) can set this directly, but for old versions, this
# hack is needed.
su -s /bin/sh -c 'exec "$0" "$@"' _laura -- /opt/laura/watcher/watcher | tee /var/log/watcher.log 2>&1

end script

respawn
