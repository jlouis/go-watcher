#######################
#Architecture overview#
#######################
:Author: giulio
:Email: giulioungaretti@me.com
:Date: 2015-07-30 22:54
-----------------------

First mode of operation reads old data (stream/from file does not matter ).
Matilde is a simple state-less easy to ship binary.

Metrics are a WIP, and can and will be tailored on sysadmin preference for monitoring.
As of now (30 Jul 2015) stream/persist with stdlib go metrics module.
In the future ship to jungo which will take care of shipping to other services (graphite and so on.)
Matilde will ship a fixed format binary message that can be processed just be reading the header (f.e.x offer.click, or metrics).

+---------------------------------------------------------------------------------------------------------------------------+
|                                                       Matilde-Write                                                       |
|                                                                                                                           |
|         +----------------------------------------------------------------------------+                                    |
|         |                                                                            |                                    |
|         |                                              +---------------+             |                                    |
|         |                      +---------------------->|  Init event   |             |                                    |
|         |                      |                       +---------------+             |                                    |
|         |                      |                               |                     |                                    |
|         |             +-----------------+                 BadEvent  bool             |                                    |
|         |             |   extract RK    |                 Cleaned   interface{}      |                                    |
|         |             +-----------------+                 Errors    []error          |                                    |
|         |                      ^                          Line      []byte           |                                    |
|         |                      |                          Raw       event.Event      |                                    |
|         |                  payload:                       Seralized []byte           |                                    |
|         | <<RKLen:8/integer, RK/binary, Msg binary>>      Type      string           |                    +------------+  |
|         |                   header:                                 |                |                    |            |  |
|         |          <<4 bytes len(payload)>>                         |                |                    |            |  |
|         |                       |                                   |                |       +----+       |  metrics   |  |
|         |                       |                                   v                |-------+HTTP+------>|  --------  |  |
|         |                       |                        +--------------------+      |       +----+       |            |  |
|         |             +-------------------+              | Serialize->msgpck  |      |                    |            |  |
|         |             |    stream from    |              +--------------------+      |                    |            |  |
|         |             |    erlang PORT    |                         |                |                    +------------+  |
|         |             +-------------------+                         v                |                                    |
|         |                       -                          +----------------+        |                                    |
|         |                       X                          |   stream to    |        |                                    |
|         |                      / \                         |  erlang PORT   |        |                                    |
|   +-----+-----+               /   \                        +----------------+        |                                    |
|   |   Fail    |<-------------|     |                                |                |                                    |
|   +-----+-----+               \   /        +------------------------+------------+   |                                    |
|         |                      \ /         |          4bytes-len(frame)          |   |                                    |
|         |                       V          |     frame: 1byte(RK) + payload      |   |                                    |
|         |                       ^          +--------------------+----------------+   |                                    |
|         |                       |                               |                    |                                    |
|         +-----------------------+-------------------------------v--------------------+                                    |
|                                 |                  +------------------------+                                             |
|                     +----------------------+       |    jungo_core_canon    |------+                                      |
|                     |   Supervisor-port    |       +------------------------+      |                                      |
|              +----->|                      |                    |                  |                                      |
|              |      +----------------------+             +------+                  |                                      |
|              |                                           v                         v                                      |
|        +-----------+                           +------------------+      +------------------+                             |
|        | JSON DATA |                           | msgppack payload |      | metrics payload  |                             |
|        +-----------+                           +------------------+      +------------------+                             |
|                                                                                                                           |
+---------------------------------------------------------------------------------------------------------------------------+

Internal of stateless matilde.

+------------------------------------------------------------------------------------------------+
|                       |                                                    +---------------+   |
|                       |                                                    |  Init event   |   |
|                       |                                                    +---------------+   |
|          +------------v------------------------------------------------------------+           |
|          |    +---------------+                                                    |           |
|          |    |     Init      |                                                    |           |
|          |    +---------------+                                                    |           |
|          |            |                                                            |           |
|          |   +--------+----------------+                                           |           |
|          |   |BadEvent  bool           |                                           |           |
|          |   |Cleaned   interface{}    |                                           |           |
|          |   |Errors    []error        |                                           |           |
|          |   |Line      []byte         |                                           |           |
|          |   |Raw       event.Event    |                                           |           |
|          |   |Seralized []byte         |                                           |           |
|          |   |Type      string         |                                           |           |
|          |   +-----------+-------------+                                           |           |
|          |               |                                                         |           |
|          |               v                                                         |           |
|          |    +--------------------+            +--------------------+             |           |
|          |    |     Parse json     |<---------->|Errors.append(Error)|             |           |
|          |    +--------------------+            +--------------------+             |           |
|          |               |                                                         |           |
|          |               +--------------+                                          |           |
|          |                              v                                          |           |
|          |                              X                                          |           |
|          | +--------------------+      / \             +--------------------+      |           |
|          | |    Clean event     |<----|   |<---------->|Errors.append(Error)|      |           |
|          | +--------------------+      \ /             +--------------------+      |           |
|          |            |                 V                                          |           |
|          |            |                 |       +--------------------------+       |           |
|          |            |                 +------>| log.fatal(db-I/0-Error)  |-------+--->       |
|          |            |                         +--------------------------+       |           |
|          |            v                                                            |           |
|          | +--------------------+            +--------------------+                |           |
|          | |     Serialize      |<---------->|Errors.append(Error)|                |           |
|          | +--------------------+            +--------------------+                |           |
|          |            |                                                            |           |
|          |            |                                                            |           |
|          +------------+------------------------------------------------------------+           |
|                       |                                                                        |
|                       |                                                                        |
|                       v                                                                        |
|                                                                                                |
|                                                                                                |
+------------------------------------------------------------------------------------------------+


Second mode of operation.
If data already cleaned needs reprocessing (name change, unit change, add info from db/ remove filed).
Now we don't need any additional code, if matilde has cleaned it can then re-process.

+---------------------------------------------------------------------------------------------------------------------------+
|  +-------------+  +-----------------+                 Matilde-Read                                                        |
|  |             |  |                 |                                                                                     |
|  | s3-msgpack  |  | amq-kafka-clean |                                                                                     |
|  |             |  |                 |---------------+                                                                     |
|  |             |  |                 |               |                                                                     |
|  +-------------+  +-----------------+               |                                                                     |
|                                                     |                                                                     |
|                                                     |                                                                     |
|                                                     |                                                                     |
|                                                     |                                                                     |
|                    +--------------------------------+-------------------------------------+                               |
|                    |                                v                                     |                               |
|                    |                   +------------------------+                         |                               |
|                    |                   |     read msg-pack      |                         |                               |
|                    |                   +------------------------+                         |                               |
|                    |                   +------------------------+                         |                               |
|                    |                   |                        |                         |                               |
|                    |                   |  Apply new transform   |                         |                               |
|                    |                   |                        |                         |                               |
|                    |                   +------------------------+                         |                               |
|                    |                   +------------------------+                         |                               |
|                    |                   |   Serialize->msgpck    |                         |                               |
|                    |                   +------------------------+                         |                               |
|                    |                                |                                     |                               |
|                    |                                |                                     |                               |
|                    |                                v                                     |                               |
|                    |                       +----------------+                             |                               |
|                    |                       |   stream to    |                             |                               |
|                    |                       |  erlang PORT   |                             |                               |
|                    |                       +----------------+                             |                               |
|                    |                                |                                     |                               |
|                    |                                |                                     |                               |
|                    |             +------------------+------------------+                  |                               |
|                    |             |          4bytes-len(frame)          |                  |                               |
|                    |             |     frame: 1byte(RK) + payload      |                  |                               |
|                    |             +-------------------------------------+                  |                               |
|                    |                                |                                     |                               |
|                    |                                |                                     |                               |
|                    +--------------------------------+-------------------------------------+                               |
|                                                     |                                                                     |
|                                                     |                                                                     |
|                                                     |                                                                     |
|                                                     v                                                                     |
|                                                                                                                           |
|                                                                                                                           |
+---------------------------------------------------------------------------------------------------------------------------+
